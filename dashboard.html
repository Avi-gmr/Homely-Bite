<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #d32f2f; --bg: #f2f2f2; --success: #28a745; --blue: #007bff; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: #333; padding-bottom: 90px; }

        .header { background: var(--primary); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .header h1 { margin: 0; font-size: 22px; }
        .view { padding: 15px; }

        .order-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-left: 5px solid var(--primary); position: relative; }
        .status-badge { position: absolute; top: 15px; right: 15px; background: #eee; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
        .info-item b { font-size: 11px; color: #888; display: block; text-transform: uppercase; margin-bottom: 2px; }
        .info-item p { margin: 0; font-size: 15px; font-weight: 600; }
        .items-box { background: #fafafa; padding: 10px; border-radius: 8px; font-size: 14px; border: 1px dashed #ddd; margin: 12px 0; }
        .bill-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-top: 1px solid #eee; margin-bottom: 10px; }
        .bill-amt { font-size: 20px; font-weight: bold; color: var(--success); }

        .otp-container { display: flex; gap: 10px; }
        .otp-input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; text-align: center; outline: none; }
        .verify-btn { background: var(--primary); color: white; border: none; padding: 0 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        .qr-box { display: none; text-align: center; margin-top: 10px; padding: 15px; background: #f0f8ff; border: 2px solid var(--blue); border-radius: 12px; }
        .qr-box img { width: 150px; height: 150px; mix-blend-mode: multiply; margin: 10px 0; }
        
        .empty-msg { text-align: center; margin-top: 50px; color: #999; }
        .sim-btn { display: block; width: 100%; max-width: 250px; margin: 20px auto; padding: 12px; background: #333; color: white; border: none; border-radius: 25px; cursor: pointer; }

        .auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box; }

        /* Credits & Navbar */
        .credits-section { text-align: center; color: #777; margin-top: 20px; }
        .credits-section h4 { margin: 0; color: #333; }
        .navbar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding: 10px 0; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-item { text-decoration: none; color: #888; text-align: center; font-size: 10px; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 3px; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>

    <div id="auth-check" class="auth-overlay">
        <i class="fas fa-lock" style="font-size: 50px; color: #ccc; margin-bottom: 20px;"></i>
        <h2>Access Restricted</h2>
        <p id="auth-msg">Checking your partner status...</p>
        <button onclick="window.location.href='index.html'" style="padding:10px 20px; margin-top:20px; background:#3498db; color:white; border:none; border-radius:5px; cursor:pointer;">Go to Registration</button>
    </div>

    <div class="header">
        <h1>HOMELY BITE</h1>
        <p>Delivery Dashboard</p>
    </div>

    <div id="main-view" class="view">
        <h4 style="margin: 0 0 15px 5px; display:flex; justify-content:space-between; align-items:center;">
            <span><i class="fas fa-motorcycle"></i> Active Orders</span>
            <span id="driver-name-display" style="font-size:12px; font-weight:normal; background:rgba(0,0,0,0.1); padding:3px 8px; border-radius:10px;"></span>
        </h4>
        
        <div id="delivery-list"></div>
        <button class="sim-btn" onclick="window.location.href='menu.html'">+ Place Test Order (Customer App)</button>
        
        <div class="credits-section">
            <h4>Created by Suraj</h4>
            <small>Hosted by Shaurya</small>
        </div>
    </div>

    <div class="navbar">
        <a href="index.html" class="nav-item">
            <i class="fas fa-user-plus"></i> Register
        </a>
        <a href="dashboard.html" class="nav-item active">
            <i class="fas fa-motorcycle"></i> Delivery
        </a>
        <a href="owner.html" class="nav-item">
            <i class="fas fa-user-shield"></i> Owner
        </a>
        <a href="menu.html" class="nav-item">
            <i class="fas fa-utensils"></i> Order Food
        </a>
    </div>

    <script>
        window.onload = () => {
            const status = localStorage.getItem('hb_status');
            const name = localStorage.getItem('hb_name');

            if (status === 'approved') {
                document.getElementById('auth-check').style.display = 'none';
                document.getElementById('driver-name-display').innerText = "Hi, " + name.split(' ')[0];
                loadAllOrders();
                setInterval(loadAllOrders, 3000); // Auto Refresh orders
            } else if (status === 'pending') {
                document.getElementById('auth-msg').innerText = "Account pending approval.";
            } else {
                document.getElementById('auth-msg').innerText = "Please register first.";
            }
        };

        function loadAllOrders() {
            // Read shared DB
            const orders = JSON.parse(localStorage.getItem('hb_orders') || "[]");
            const listContainer = document.getElementById('delivery-list');
            if (orders.length === 0) { listContainer.innerHTML = `<div class="empty-msg">No active orders.<br><small>Open Customer App to place one.</small></div>`; return; }

            listContainer.innerHTML = orders.reverse().map((order) => `
                <div class="order-card" id="card-${order.id}">
                    <div class="status-badge" style="color:${order.status === 'delivered' ? 'green' : 'orange'}">
                        ${order.status === 'delivered' ? 'Done' : 'On Way'}
                    </div>
                    <div class="info-grid">
                        <div class="info-item"><b>Customer</b><p>${order.customerName}</p></div>
                        <div class="info-item"><b>Phone</b><p>${order.phone}</p></div>
                    </div>
                    <div class="info-item" style="margin-bottom:8px;"><b>Address</b><p>${order.address}</p></div>
                    <div class="items-box"><b>#${order.id.toString().slice(-4)}:</b> ${order.items}</div>
                    <div class="bill-row"><span>Collect:</span><span class="bill-amt">â‚¹${order.total}</span></div>

                    <div id="otp-area-${order.id}" style="${order.status === 'delivered' ? 'display:none' : 'block'}">
                        <p style="font-size:12px; color:#777;">Ask Customer for OTP (It is <b>${order.otp}</b> for demo)</p>
                        <div class="otp-container">
                            <input type="number" id="input-otp-${order.id}" class="otp-input" placeholder="Enter OTP">
                            <button class="verify-btn" onclick="verifyOrder(${order.id}, ${order.otp})">Verify</button>
                        </div>
                    </div>
                    <div class="qr-box" id="qr-area-${order.id}" style="${order.status === 'delivered' ? 'display:block' : 'none'}">
                        <span style="color:#007bff; font-weight:bold;">PAYMENT RECEIVED</span><br>
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=Paid${order.id}">
                    </div>
                </div>
            `).join('');
        }

        function verifyOrder(orderId, correctOtp) {
            const inputVal = document.getElementById(`input-otp-${orderId}`).value;
            // Demo mode: accept correct OTP or blank (for easy testing)
            if (inputVal == correctOtp) {
                let orders = JSON.parse(localStorage.getItem('hb_orders') || "[]");
                // Update status in Shared DB
                orders = orders.map(o => { if(o.id === orderId) o.status = 'delivered'; return o; });
                localStorage.setItem('hb_orders', JSON.stringify(orders));
                loadAllOrders();
                alert("OTP Verified! Order marked as Delivered.");
            } else { alert("Wrong OTP"); }
        }
    </script>
</body>
</html>
